# lambda-ecr-vcs
This lambda function should be triggered by an [ECR Image Action](https://docs.aws.amazon.com/AmazonECR/latest/userguide/ecr-eventbridge.html#ecr-eventbridge-bus)
generated by EventBridge. To invoke the lambda every time a new image is being pushed to
ECR you can use the following EventBridge filter pattern:

```json
{
  "source": ["aws.ecr"],
  "detail-type": ["ECR Image Action"],
  "detail": {
    "action-type": ["PUSH"],
    "result": ["SUCCESS"]
  }
}
```

The function fetches the manifest of the newly pushed image and extracts the following image labels:

* **org.label-schema.vcs-url**: URL for the source code under version control from which this container image was built
* **org.label-schema.vcs-ref**: Identifier for the version of the source code from which this image was built
* **org.factory360.vcs-branch**: Branch of the source code from which the image was built
* **org.factory360.vcs-author**: Author of the commit this image was built from
* **org.factory360.vcs-message**: Message of the commit this image was built from

For further processing it returns a JSON object with the following fields:

```json
{
  "repo_url": "<org.label-schema.vcs-url>",
  "branch": "<org.factory360.vcs-branch>",
  "author": "<org.factory360.vcs-author>",
  "ref": "<org.label-schema.vcs-ref>",
  "message": "<org.factory360.vcs-message>",
  "image": "123456789012.dkr.ecr.us-west-2.amazonaws.com/test:latest"
}
```
